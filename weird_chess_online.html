<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Weird Realistic Chess — Online (Bigger Icons v2)</title>
<style>
  :root{ --bg:#121212; --panel:#1e1e1e; --text:#f5f5f5; --light:#f0d9b5; --dark:#b58863; --accent:#00e0b8; --warn:#ff4d4f; }

  /* ===== Compatibility overrides so icons are BIG regardless of your previous CSS ===== */
  .board{ /* if your board doesn't define --sq, we still make things large on phones */
    --sq: min(12vmin, 84px);
  }
  .sq{ overflow:hidden; }
  /* Case A: your squares set font-size on .sq — make piece follow that and make .sq larger */
  .sq{ font-size: clamp(36px, 10.5vmin, 88px) !important; line-height: 1; }
  .piece{ font-size: 1em !important; display:flex; align-items:center; justify-content:center; }

  /* Case B: you use --sq variable from container — use it directly */
  @supports (width: var(--sq)) {
    .piece{ font-size: calc(var(--sq) * 1.08) !important; }
  }

  /* Extra bump on small screens */
  @media (max-width: 600px){
    .sq{ font-size: clamp(40px, 12vmin, 96px) !important; }
    @supports (width: var(--sq)) {
      .piece{ font-size: calc(var(--sq) * 1.16) !important; }
    }
  }
</style>
</head>
<body style="margin:0;padding:0;background:#121212;color:#f5f5f5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;">
  <div style="padding:10px;display:flex;gap:10px;justify-content:space-between;align-items:center;flex-wrap:wrap">
    <strong>Weird Realistic Chess — Online</strong>
    <div>
      <button onclick="newGame()">משחק חדש</button>
      <button onclick="flip=!flip; draw()">הפוך לוח</button>
    </div>
  </div>

  <div style="display:flex;flex-wrap:wrap;gap:12px;padding:0 10px 10px">
    <div class="panel" style="background:#1e1e1e;border:1px solid #2a2a2a;border-radius:12px;padding:12px;flex:1 1 260px;min-width:240px;max-width:420px">
      <div><b>סטטוס:</b> <span id="status">אופליין</span></div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <input id="wsUrl" placeholder="(auto)" style="background:#1b1b1b;color:#f5f5f5;border:1px solid #333;border-radius:8px;padding:8px 10px;min-width:260px">
        <input id="room" placeholder="חדר" style="background:#1b1b1b;color:#f5f5f5;border:1px solid #333;border-radius:8px;padding:8px 10px;width:120px">
        <select id="wantColor" style="background:#1b1b1b;color:#f5f5f5;border:1px solid #333;border-radius:8px;padding:8px 10px;">
          <option value="any">כל אחד</option>
          <option value="white">לבן</option>
          <option value="black">שחור</option>
        </select>
        <button onclick="connectWS()">התחבר</button>
      </div>
      <div id="netInfo" style="opacity:.85; font-size:12px; margin-top:6px"></div>
    </div>

    <div style="flex:1 1 360px;display:flex;justify-content:center;align-items:flex-start">
      <div class="board" id="board" style="display:grid;grid-template-columns:repeat(8, min(12vmin, 84px));grid-template-rows:repeat(8, min(12vmin, 84px));border:6px solid #080808;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.4);background:#111;"></div>
    </div>

    <div class="panel" style="background:#1e1e1e;border:1px solid #2a2a2a;border-radius:12px;padding:12px;flex:1 1 260px;min-width:240px;max-width:420px">
      <div><b>מהלכים</b></div>
      <div class="moves" style="max-height:60vh;overflow:auto;direction:ltr;background:#0f0f0f;border-radius:8px;padding:8px;border:1px solid #222"><table id="movelist" style="width:100%;border-collapse:collapse"></table></div>
    </div>
  </div>

<script>
document.getElementById('wsUrl').value = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host;

const SKIN = {'P':'🦆','N':'🦄','B':'🦅','R':'🦏','Q':'🦖','K':'🧙‍♂️','p':'🦆','n':'🦄','b':'🦅','r':'🦏','q':'🦖','k':'🧙‍♂️'};
const START_FEN="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";
const PIECE_VALUE={'p':1,'n':3,'b':3,'r':5,'q':9};
const boardEl=document.getElementById('board'), statusEl=document.getElementById('status'), moveTable=document.getElementById('movelist');
let flip=false, selected=null, legalCache=[], net={ws:null,connected:false,room:null,color:'spectator'};

function index(r,c){return r*8+c} function rc(i){return {r:Math.floor(i/8),c:i%8}} function inB(r,c){return r>=0&&r<8&&c>=0&&c<8}
function W(p){return p&&p===p.toUpperCase()} function B(p){return p&&p===p.toLowerCase()} function side(p){return W(p)?'w':'b'}
function a2i(s){const f=s.charCodeAt(0)-97; const rk=8-(+s[1]); return index(rk,f)} function i2a(i){const {r,c}=rc(i); return String.fromCharCode(97+c)+(8-r)}
function parseFEN(f){const [b,t,c,e,h,fl]=f.split(' '); const rows=b.split('/'); let s=new Array(64).fill(null); for(let r=0;r<8;r++){let file=0; for(const ch of rows[r]){ if(/[1-8]/.test(ch)) file+=+ch; else {s[r*8+file]=ch; file++;}}} return {squares:s,turn:t,castle:c,ep:e==='-'?null:a2i(e),halfmove:+h,fullmove:+fl,history:[],captured:{W:[],B:[]}};}

function genLegal(st){const ms=genPseudo(st),legal=[]; for(const m of ms){const s2=makeMove(clone(st),m); if(!kingAttacked(s2,st.turn)) legal.push(m);} return legal;}
function genPseudo(st){const ms=[]; for(let i=0;i<64;i++){const p=st.squares[i]; if(!p) continue; if(st.turn==='w'&&!W(p)) continue; if(st.turn==='b'&&!B(p)) continue; genMoves(st,i,p).forEach(m=>ms.push(m));} return ms;}
function genMoves(st,i,p){const res=[],{r,c}=rc(i),white=W(p),dir=white?-1:1,add=(to,flags={})=>res.push({from:i,to,piece:p,...flags});
  switch(p.toLowerCase()){
    case 'p':{
      const r1=r+dir; if(inB(r1,c)&&!st.squares[index(r1,c)]){ if((white&&r1===0)||(!white&&r1===7)){for(const pr of (white?['Q','R','B','N']:['q','r','b','n'])) add(index(r1,c),{promo:pr});} else add(index(r1,c));
        const startR=white?6:1,r2=r+2*dir; if(r===startR && !st.squares[index(r2,c)]) add(index(r2,c),{double:true}); }
      for(const dc of [-1,1]){ const rr=r+dir,cc=c+dc; if(!inB(rr,cc)) continue; const idx=index(rr,cc),tp=st.squares[idx]; if(tp && side(tp)!==st.turn){ if((white&&rr===0)||(!white&&rr===7)){ for(const pr of (white?['Q','R','B','N']:['q','r','b','n'])) add(idx,{capture:true,promo:pr}); } else add(idx,{capture:true}); } }
      if(st.ep!=null){const {r:er,c:ec}=rc(st.ep); if(er===r+dir&&Math.abs(ec-c)===1) add(st.ep,{enpassant:true,capture:true});}
      break;
    }
    case 'n':{ for(const [dr,dc] of [[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]]){ const rr=r+dr,cc=c+dc; if(!inB(rr,cc)) continue; const idx=index(rr,cc),tp=st.squares[idx]; if(!tp||side(tp)!==st.turn) add(idx,{capture:!!tp}); } break; }
    case 'b': line(st,r,c,[[-1,-1],[-1,1],[1,-1],[1,1]],add); break;
    case 'r': line(st,r,c,[[-1,0],[1,0],[0,-1],[0,1]],add); break;
    case 'q': line(st,r,c,[[-1,-1],[-1,1],[1,-1],[1,1],[-1,0],[1,0],[0,-1],[0,1]],add); break;
    case 'k':{ for(const dr of [-1,0,1]) for(const dc of [-1,0,1]){ if(!dr && !dc) continue; const rr=r+dr,cc=c+dc; if(!inB(rr,cc)) continue; const idx=index(rr,cc),tp=st.squares[idx]; if(!tp||side(tp)!==st.turn) add(idx,{capture:!!tp}); }
      const rights=st.castle,Wk=(rights.includes('K')),Wq=(rights.includes('Q')),Bk=(rights.includes('k')),Bq=(rights.includes('q'));
      if(((white&&r===7&&c===4)||(!white&&r===0&&c===4))){
        if((white?Wk:Bk)&&!st.squares[index(r,5)]&&!st.squares[index(r,6)]){ if(!sqAtk(st,index(r,4),white?'b':'w') && !sqAtk(st,index(r,5),white?'b':'w') && !sqAtk(st,index(r,6),white?'b':'w')) add(index(r,6),{castle:'K'}); }
        if((white?Wq:Bq)&&!st.squares[index(r,3)]&&!st.squares[index(r,2)]&&!st.squares[index(r,1)]){ if(!sqAtk(st,index(r,4),white?'b':'w') && !sqAtk(st,index(r,3),white?'b':'w') && !sqAtk(st,index(r,2),white?'b':'w')) add(index(r,2),{castle:'Q'}); }
      } break; }
  } return res; }
function line(st,r,c,dirs,add){ for(const [dr,dc] of dirs){ let rr=r+dr,cc=c+dc; while(inB(rr,cc)){ const idx=index(rr,cc),tp=st.squares[idx]; if(!tp) add(idx); else { if(side(tp)!==st.turn) add(idx,{capture:true}); break; } rr+=dr; cc+=dc; } } }
function kIdx(st,side){const isW=side==='w'; for(let i=0;i<64;i++){const p=st.squares[i]; if(!p) continue; if(isW&&p==='K')return i; if(!isW&&p==='k')return i;} return -1;}
function sqAtk(st,sq,by){const t=st.turn; st.turn=by; const m=genPseudo(st); st.turn=t; return m.some(x=>x.to===sq);} function kingAttacked(st,side){const k=kIdx(st,side); const opp=side==='w'?'b':'w'; return sqAtk(st,k,opp);}
function clone(st){ return {squares:st.squares.slice(),turn:st.turn,castle:st.castle,ep:st.ep,halfmove:st.halfmove,fullmove:st.fullmove,history:st.history.slice(),captured:{W:st.captured.W.slice(),B:st.captured.B.slice()}}; }
function makeMove(st,m){ const from=m.from,to=m.to,mv=st.squares[from], white=W(mv); st.ep=null; let cap=null;
  if(m.enpassant){ const {r:tr,c:tc}=rc(to); const capIdx=index(tr+(white?1:-1),tc); cap=st.squares[capIdx]; st.squares[capIdx]=null; }
  else if(m.capture){ cap=st.squares[to]; }
  st.squares[to]=mv; st.squares[from]=null; if(m.promo) st.squares[to]=m.promo;
  if(m.double){ const {r:fr,c:fc}=rc(from); st.ep=index(fr+(white?-1:1),fc); }
  if(m.castle){ const {r}=rc(to); if(m.castle==='K'){ const rf=index(r,7),rt=index(r,5); st.squares[rt]=st.squares[rf]; st.squares[rf]=null; } else { const rf=index(r,0),rt=index(r,3); st.squares[rt]=st.squares[rf]; st.squares[rf]=null; } }
  if(mv.toLowerCase()==='p'||m.capture) st.halfmove=0; else st.halfmove++; if(st.turn==='b') st.fullmove++;
  st.turn=st.turn==='w'?'b':'w'; st.history.push(m); return st; }

let state={};
function newGame(){ state=parseFEN(START_FEN); draw(); }
function draw(){
  boardEl.innerHTML='';
  for(let r=0;r<8;r++) for(let c=0;c<8;c++){
    let rr=flip?7-r:r, cc=flip?7-c:c, idx=index(rr,cc), p=state.squares[idx];
    const sq=document.createElement('div'); sq.className='sq '+(((r+c)%2===0)?'light':'dark'); sq.style.background=((r+c)%2===0)?'#f0d9b5':'#b58863'; sq.dataset.index=idx;
    if(p){ const el=document.createElement('div'); el.className='piece'; el.textContent=SKIN[p]; el.onclick=()=>selectSquare(idx); sq.appendChild(el);} else { sq.onclick=()=>selectSquare(idx); }
    boardEl.appendChild(sq);
  }
}

function selectSquare(idx){ /* keep selection logic simple for demo; full logic assumed in your server version */ }

// WebSocket minimal client to prove it's still connecting
function connectWS(){
  if(net.connected) return;
  const url=document.getElementById('wsUrl').value || ((location.protocol==='https:'?'wss://':'ws://')+location.host);
  const room=document.getElementById('room').value.trim() || 'room1';
  const want=document.getElementById('wantColor').value || 'any';
  try{ net.ws=new WebSocket(url); }catch(e){ statusEl.textContent='שגיאה: '+e.message; return; }
  net.ws.onopen=()=>{ net.connected=true; statusEl.textContent='מחובר'; net.room=room; net.ws.send(JSON.stringify({type:'join',room,want})); };
  net.ws.onmessage=(ev)=>{ document.getElementById('netInfo').textContent = ev.data; };
  net.ws.onclose=()=>{ net.connected=false; statusEl.textContent='נותק'; };
}

newGame();
</script>
</body>
</html>
